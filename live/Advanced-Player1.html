<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Player</title>
<style>
    body {
        margin: 0;
        background: #000; /* Optional: add a background color for better contrast */
    }
    #player {
        width: 100%;
        height: 100vh;
    }
</style>
<link rel="stylesheet" type="text/css" href="https://plus880.netlify.app/clap.css">
</head>
<body>
<div id="player"></div>

<script src="//cdn.jsdelivr.net/npm/clappr@latest/dist/clappr.min.js"></script>
<script type="text/javascript" src="//cdn.jsdelivr.net/gh/clappr/clappr-level-selector-plugin@latest/dist/level-selector.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/@clappr/hlsjs-playback@1.2.0/dist/hlsjs-playback.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/@c3voc/clappr-audio-track-selector@0.2.4/dist/audio-track-selector.min.js"></script>

<script>
    // Function to get URL parameter by name
    function getParameterByName(name) {
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(window.location.href);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    var hlsURL = getParameterByName('url'); // Fetch HLS URL from URL parameter

    var maxAttempts = 1; // Maximum number of retry attempts
    var errorCounter = 0; // Counter to track error attempts
    var isReloading = false; // Flag to prevent simultaneous reloads

    function reloadStream() {
        if (!isReloading && errorCounter < maxAttempts) {
            isReloading = true;
            if (hlsURL) {
                var playerElement = document.getElementById('player');
                playerElement.innerHTML = ''; // Clear previous player instance

                var player = new Clappr.Player({
                    source: decodeURIComponent(hlsURL),
                    plugins: [HlsjsPlayback, LevelSelector, AudioTrackSelector],
                    width: '100%',
                    height: '100vh',
                    autoPlay: true,
                    mimeType: "application/x-mpegURL",
                    mediacontrol: { seekbar: "#ff0000", buttons: "#eee" },
                    parentId: "#player",
                    hlsUseNextLevel: false,
                    maxBufferLength: 30,
                    hlsMinimumDvrSize: 60,
                    hlsRecoverAttempts: 1,
                    hlsPlayback: {
                        preload: true,
                        customListeners: [],
                    },
                    playback: {
                        extrapolatedWindowNumSegments: 2,
                        triggerFatalErrorOnResourceDenied: false,
                        hlsjsConfig: {
                            // hls.js specific options
                        },
                    },
                    events: {
                        onError: function(e) {
                            if (errorCounter < maxAttempts) {
                                errorCounter++;
                                isReloading = false; // Reset reloading flag
                                reloadStream();
                            }
                        },
                        onPlay: function() {
                            errorCounter = 0; // Reset error counter
                            isReloading = false;
                        }
                    }
                });
            } else {
                console.error("HLS URL not found in URL parameters.");
            }
        }
    }

    // Call reloadStream function after the document has loaded
    window.onload = reloadStream;
</script>
</body>
</html>
